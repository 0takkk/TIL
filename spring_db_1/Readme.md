# 스프링 DB 1편 - 데이터 접근 핵심 원리

## DB 락

두 트랜잭션이 동일한 데이터를 동시에 수정하면 문제가 발생한다.  
이런 문제를 방지하기 위해, 트랜잭션을 시작하고 데이터를 수정하는 동안 다른 트랜잭션이 해당 데이터를 수정할 수 없게 막아야 한다.  
데이터베이스는 이런 문제를 해결하기 위해 `락(Lock)`이라는 개념을 제공한다.

<br>

일반적인 조회는 락을 사용하지 않지만, 데이터를 조회할 때 락을 획득해야 할 때가 있다.  
이럴 때는 `select for update` 구문을 사용하면 된다.

<br>

## 자바 예외

<img width="596" alt="image" src="https://github.com/0takkk/inflearn/assets/89503136/927334a1-efb4-4743-a827-3bffebf6c206">

예외는 잡아서 처리하거나, 처리할 수 없으면 밖으로 던져야한다.

<img width="594" alt="image" src="https://github.com/0takkk/inflearn/assets/89503136/8b25127e-90b4-4cf3-81f8-597f95870610">
<img width="597" alt="image" src="https://github.com/0takkk/inflearn/assets/89503136/49d375c2-41e9-4f11-a59b-7357c265a4e9">

자바 main() 스레드는 예외를 처리하지 않으면 예외 로그를 출력하고 시스템이 종료된다.  
웹 어플리케이션은 여러 사용자의 요청을 처리하기 때문에 하나의 예외 때문에 시스템이 종료될 수 있다.

<br>

### CheckedException

`CheckedException`은 예외를 잡어서 처리하거나, `throws`로 예외를 밖으로 던지는 것을 필수로 해야한다.  
그렇지 않으면 **컴파일 오류**가 발생한다.

- **장점** : 개발자가 실수로 예외를 누락하지 않도록 컴파일러를 통해 문제를 잡아주는 안정장치가 된다.
- **단점** : 개발자가 모든 체크 예외를 반드시 잡거나 던지도록 처리해야한다. 추가로 의존 관계에 따른 단점도 존재한다.

### UncheckedException

`UncheckedException`은 컴파일러가 예외를 체크하지 않는다.

- **장점** : 신경쓰고 싶지 않은 언체크 예외를 무시할 수 있다. 따라서, 의존 관계를 참조하지 않아도 된다.
- **단점** : 언체크 예외는 개발자가 실수로 예외를 누락할 수 있다.

### 체크 예외와 언체크 예외의 사용

**기본적으로 언체크 예외를 사용한다.**  
체크 예외는 비즈니스 로직상 의도적으로 던지는 예외에만 사용한다. ex) 계좌 이체 실패, 결제시 포인트 부족

<img width="597" alt="image" src="https://github.com/0takkk/inflearn/assets/89503136/46b9a0ed-b912-4b92-8d91-25afc976556f">

서비스단에서는 `SQLException`, `ConnectException`을 처리할 수 없고, 던져야한다.  
또한, 이런 문제들은 사용자에게 어떤 문제가 발생했는지 자세히 설명하기 어렵다.  
이렇게 해결이 불가능한 공통 예외는 오류 로그로 남겨 인지할 수 있도록 해야한다.

<br>

체크 예외의 또 다른 문제는 예외에 대한 의존 관계에 있다.  
`Controller`나 `Service`는 본인이 처리할 수 없는 예외를 `throws`로 선언해야 한다.  
그러면, 이는 `Controller`나 `Service`는 예외에 의존적이게 되는 것이다.

## 스프링 예외 처리

<img width="781" alt="image" src="https://github.com/0takkk/inflearn/assets/89503136/fe2830f5-0333-4757-bc87-47d4bce2547a">

스프링은 데이터 접근 계층에 대한 예외를 정리해서 일관된 예외 계층을 제공한다.  
따라서, 특정 기술에 종속적이지 않고, 서비스 계층에서는 스프링이 제공하는 예외를 사용하면 된다.  
JDBC를 사용하던, JPA를 사용하던 발생하는 예외를 스프링이 제공하는 예외로 변환해준다.
